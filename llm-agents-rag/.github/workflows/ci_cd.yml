name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  # Define image names for consistency
  RAG_IMAGE: llm-rag-service
  INFERENCE_IMAGE: llm-inference-service

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Lint and Test
  # ---------------------------------------------------------------------------
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest
        # Install base requirements for linting
        pip install -r requirements.txt

    - name: Lint with flake8
      run: |
        # Stop on syntax errors or undefined names
        flake8 src services --count --select=E9,F63,F7,F82 --show-source --statistics
        # Warnings (non-blocking)
        flake8 src services --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run tests
      run: |
        echo "Running tests..."
        # pytest tests/ -v  # Uncomment when tests are added

  # ---------------------------------------------------------------------------
  # Job 2: Build RAG Service Image
  # ---------------------------------------------------------------------------
  build-rag-service:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build RAG Service Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./services/rag_service/Dockerfile
        push: false
        tags: ${{ env.RAG_IMAGE }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Job 3: Build Inference Service Image
  # ---------------------------------------------------------------------------
  build-inference-service:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Inference Service Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./services/inference_service/Dockerfile
        push: false
        tags: ${{ env.INFERENCE_IMAGE }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Job 4: Integration Test (Optional - runs docker-compose)
  # ---------------------------------------------------------------------------
  integration-test:
    runs-on: ubuntu-latest
    needs: [build-rag-service, build-inference-service]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Create dummy .env file
      run: |
        echo "GOOGLE_API_KEY=test_key_for_build" > .env

    - name: Build and start services
      run: |
        docker-compose build
        docker-compose up -d
        sleep 10  # Wait for services to initialize

    - name: Check service health
      run: |
        # Check RAG service
        curl -f http://localhost:8001/health || exit 1
        # Check Inference service
        curl -f http://localhost:8000/health || exit 1

    - name: Tear down
      if: always()
      run: docker-compose down -v

  # ---------------------------------------------------------------------------
  # Job 5: Push Images (Only on main branch merge)
  # ---------------------------------------------------------------------------
  # push-images:
  #   runs-on: ubuntu-latest
  #   needs: integration-test
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #   - uses: actions/checkout@v4
  #   - name: Login to Container Registry
  #     uses: docker/login-action@v3
  #     with:
  #       registry: ghcr.io
  #       username: ${{ github.actor }}
  #       password: ${{ secrets.GITHUB_TOKEN }}
  #   - name: Build and Push RAG Service
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: .
  #       file: ./services/rag_service/Dockerfile
  #       push: true
  #       tags: ghcr.io/${{ github.repository }}/rag-service:latest
  #   - name: Build and Push Inference Service
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: .
  #       file: ./services/inference_service/Dockerfile
  #       push: true
  #       tags: ghcr.io/${{ github.repository }}/inference-service:latest
